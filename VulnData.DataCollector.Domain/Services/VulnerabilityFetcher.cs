using Microsoft.Extensions.Options;
using VulnData.DataCollector.Application.Dtos.Nvd;
using VulnData.DataCollector.Application.Interfaces.Domain;
using VulnData.DataCollector.Domain.Options;

namespace VulnData.DataCollector.Domain.Services;

public class VulnerabilityFetcher : IVulnerabilityFetcher
{
    private readonly IHttpClientFactory _httpClientFactory;
    private readonly NvdOption _nvdOption;
    
    public VulnerabilityFetcher(IOptions<NvdOption> options, IHttpClientFactory httpClientFactory)
    {
        _httpClientFactory = httpClientFactory;
        _nvdOption = options.Value;
    }
    
    public async Task<List<Vulnerability>> GetDataAsync(int startIndex, int maxResults)
    {
        var apiUrl = $"https://services.nvd.nist.gov/rest/json/cves/2.0/?resultsPerPage={maxResults}&startIndex={startIndex}";
        
        var client = _httpClientFactory.CreateClient();
        
        if (_nvdOption != null && !string.IsNullOrEmpty(_nvdOption.ApiKey))
            client.DefaultRequestHeaders.Add("apikey", _nvdOption.ApiKey);
        
        var response = await client.GetAsync(apiUrl);
        response.EnsureSuccessStatusCode();
        
        NvdData nvdData = await response.Content.ReadFromJsonAsync<NvdData>();
        
        return nvdData.Vulnerabilities;
    }

    public async Task<int> GetVulnCountAsync()
    {
        const int startIndex = 0;
        const int maxResults = 100;
        
        var apiUrl = $"https://services.nvd.nist.gov/rest/json/cves/2.0/?resultsPerPage={maxResults}&startIndex={startIndex}";
        
        var client = _httpClientFactory.CreateClient();
        
        if (_nvdOption != null && !string.IsNullOrEmpty(_nvdOption.ApiKey))
            client.DefaultRequestHeaders.Add("apikey", _nvdOption.ApiKey);
        
        var response = await client.GetAsync(apiUrl);
        response.EnsureSuccessStatusCode();
        
        NvdData nvdData = await response.Content.ReadFromJsonAsync<NvdData>();
        
        return nvdData.TotalResults;
    }
}